select
    utm_medium_regrouping
    ,utm_medium
    ,platform_new
    ,sum(pv_flag) as pv
    ,count(distinct virturlSession) as sessions
    ,count(distinct user_id) as uv
    ,count(distinct reg_success_flag) as new_register_users
    ,count(distinct pay_succ_uv_flag) as customers
    ,count(distinct new_pur_user_flag) as new_customers
    ,count(distinct order_id) as orders
    ,sum(order_amount) as gmv
    ,case when count(distinct order_id) = 0 then null else sum(order_amount) / count(distinct order_id) end  as aov
    ,case when sum(order_amount) = 0 then null else (sum(order_amount) - sum(cost_amount)) / sum(order_amount)  end as margin_rate
    ,case when count(distinct virturlSession) = 0 then null else count(distinct session_bounce_flag) / count(distinct virturlSession) end as session_bouns_rate
    ,count(distinct user_id) - count(distinct user_bounce_flag) as valid_uv
    ,count(distinct addcard_uv_flag) as addcart_uv
    ,count(submit_order_uv_flag) as submit_order_uv
    ,case when (count(distinct user_id) - count(distinct user_bounce_flag)) = 0 then null else count(distinct addcard_uv_flag) / (count(distinct user_id) - count(distinct user_bounce_flag)) end as addcart_uv_dividedby_valid_uv
    ,case when count(distinct addcard_uv_flag) = 0 then null else count(submit_order_uv_flag)/ count(distinct addcard_uv_flag) end as submit_order_uv_dividedby_addcart_uv
    ,case when count(submit_order_uv_flag) = 0 then null else count(distinct pay_succ_uv_flag) / count(submit_order_uv_flag) end as customers_dividedby_submit_order_uv
    ,case when count(distinct virturlSession) = 0 then null else count(distinct order_id) / count(distinct virturlSession) end as orders_dividedby_sessions 
    ,count(distinct new_uservisit_flag) as new_visitors
    ,count(distinct new_visit_flag) as new_divices

from 
    sum_event.event_allvisitor_action_detail
    
where 
    day_id = '2019-03-30'
    
group by
    day_id
    ,utm_medium_regrouping
    ,utm_medium
    ,platform_new
	
	
	+++++++++
	